<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯¹è¯å°å±‹ - KidsEnglish</title>
  <link rel="stylesheet" href="../css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header class="header">
      <div class="logo">
        <span class="logo-icon">ğŸ¼</span>
        <span>KidsEnglish</span>
      </div>
      <div style="display: flex; gap: 15px; align-items: center;">
        <div class="progress-bar">
          <span>â­</span>
          <span class="star-count">0</span>
        </div>
        <button class="back-btn" onclick="goBack()">â† è¿”å›</button>
      </div>
    </header>

    <!-- æ¨¡å—æ ‡é¢˜ -->
    <div class="module-header">
      <h1 class="module-title" style="color: var(--primary-pink);">ğŸ’¬ å¯¹è¯å°å±‹</h1>
      <p>ç‚¹å‡»å¯¹è¯ï¼Œå­¦ä¹ æ—¥å¸¸äº¤æµï¼</p>
    </div>

    <!-- å¯¹è¯åœºæ™¯ -->
    <div class="dialogue-container" id="dialogueContainer">
      <!-- å¯¹è¯åœºæ™¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>

  <script src="../data/content.js"></script>
  <script src="../js/main.js"></script>
  <script>
    let practicedLines = new Set();

    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', () => {
      loadProgress();
      renderDialogues();
    });

    // æ¸²æŸ“å¯¹è¯åœºæ™¯
    function renderDialogues() {
      const container = document.getElementById('dialogueContainer');
      container.innerHTML = '';
      
      dialogueData.forEach((scene, sceneIndex) => {
        const sceneDiv = document.createElement('div');
        sceneDiv.className = 'dialogue-scene fade-in';
        sceneDiv.style.animationDelay = `${sceneIndex * 0.1}s`;
        
        let linesHtml = '';
        scene.lines.forEach((line, lineIndex) => {
          const lineKey = `${sceneIndex}_${lineIndex}`;
          const isPracticed = practicedLines.has(lineKey);
          
          linesHtml += `
            <div class="dialogue-line" onclick="practiceLine('${line.english.replace(/'/g, "\\'")}', '${lineKey}', this)" style="${isPracticed ? 'border-left: 5px solid var(--primary-green);' : ''}">
              <div class="speaker-icon">${line.icon}</div>
              <div class="dialogue-text">
                <div class="dialogue-english">${line.english}</div>
                <div class="dialogue-chinese">${line.chinese}</div>
              </div>
              <div class="play-icon">â–¶ï¸</div>
            </div>
          `;
        });
        
        sceneDiv.innerHTML = `
          <div class="scene-title">${scene.icon} ${scene.title}</div>
          ${linesHtml}
        `;
        
        container.appendChild(sceneDiv);
      });
    }

    // ç»ƒä¹ å¯¹è¯
    function practiceLine(english, lineKey, element) {
      SoundManager.playClick();
      
      // æ’­æ”¾è‹±è¯­
      SpeechManager.speak(english);
      
      // æ ‡è®°ä¸ºå·²ç»ƒä¹ 
      if (!practicedLines.has(lineKey)) {
        practicedLines.add(lineKey);
        element.style.borderLeft = '5px solid var(--primary-green)';
        
        // æ¯ç»ƒä¹ 4å¥å¯¹è¯å¥–åŠ±ä¸€é¢—æ˜Ÿ
        if (practicedLines.size % 4 === 0) {
          ProgressManager.addStars(1);
          showEncouragement();
        }
        
        saveProgress();
      }
      
      // æ·»åŠ åŠ¨ç”»æ•ˆæœ
      element.style.transform = 'translateX(15px)';
      setTimeout(() => {
        element.style.transform = '';
      }, 200);
    }

    // æ˜¾ç¤ºé¼“åŠ±
    function showEncouragement() {
      const messages = [
        'å¯¹è¯è¯´å¾—çœŸå¥½ï¼',
        'ä½ çœŸæ£’ï¼',
        'ç»§ç»­ç»ƒä¹ ï¼',
        'è¶Šæ¥è¶Šå¥½äº†ï¼'
      ];
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];
      
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, var(--primary-pink) 0%, #F48FB1 100%);
        color: white;
        padding: 30px 50px;
        border-radius: 20px;
        font-size: 28px;
        font-weight: 800;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        z-index: 1000;
        animation: fadeIn 0.3s;
      `;
      toast.textContent = `â­ ${randomMessage}`;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 2000);
    }

    // ä¿å­˜è¿›åº¦
    function saveProgress() {
      const totalLines = dialogueData.reduce((sum, scene) => sum + scene.lines.length, 0);
      const progress = Math.round((practicedLines.size / totalLines) * 100);
      ProgressManager.setProgress('dialogue', progress);
      localStorage.setItem('kidsEnglish_practicedLines', JSON.stringify([...practicedLines]));
    }

    // åŠ è½½è¿›åº¦
    function loadProgress() {
      const saved = localStorage.getItem('kidsEnglish_practicedLines');
      if (saved) {
        practicedLines = new Set(JSON.parse(saved));
      }
    }

    // è¿”å›å¤§å…
    function goBack() {
      SoundManager.playClick();
      window.location.href = '../hall.html';
    }
  </script>
</body>
</html>
