<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¸¸æˆå¤©åœ° - KidsEnglish</title>
  <link rel="stylesheet" href="../css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header class="header">
      <div class="logo">
        <span class="logo-icon">ğŸ¼</span>
        <span>KidsEnglish</span>
      </div>
      <div style="display: flex; gap: 15px; align-items: center;">
        <div class="progress-bar">
          <span>â­</span>
          <span class="star-count">0</span>
        </div>
        <button class="back-btn" onclick="goBack()">â† è¿”å›</button>
      </div>
    </header>

    <!-- æ¸¸æˆé€‰æ‹©ç•Œé¢ -->
    <div id="gamesMenu">
      <div class="module-header">
        <h1 class="module-title" style="color: var(--primary-orange);">ğŸ® æ¸¸æˆå¤©åœ°</h1>
        <p>é€‰æ‹©æ¸¸æˆï¼Œè¾¹ç©è¾¹å­¦ï¼</p>
      </div>

      <div class="games-grid">
        <div class="game-card" onclick="startGame('memory')">
          <div class="game-icon">ğŸƒ</div>
          <div class="game-title">è®°å¿†ç¿»ç‰Œ</div>
          <div class="game-desc">æ‰¾å‡ºç›¸åŒçš„å•è¯å¡ç‰‡ï¼</div>
          <button class="game-btn">å¼€å§‹æ¸¸æˆ</button>
        </div>

        <div class="game-card" onclick="startGame('listening')">
          <div class="game-icon">ğŸ‘‚</div>
          <div class="game-title">å¬éŸ³é€‰å›¾</div>
          <div class="game-desc">å¬åˆ°ä»€ä¹ˆå°±é€‰ä»€ä¹ˆï¼</div>
          <button class="game-btn">å¼€å§‹æ¸¸æˆ</button>
        </div>

        <div class="game-card" onclick="startGame('puzzle')">
          <div class="game-icon">ğŸ§©</div>
          <div class="game-title">å•è¯æ‹¼å›¾</div>
          <div class="game-desc">æŠŠå­—æ¯æ‹¼æˆæ­£ç¡®çš„å•è¯ï¼</div>
          <button class="game-btn">å¼€å§‹æ¸¸æˆ</button>
        </div>
      </div>
    </div>

    <!-- è®°å¿†æ¸¸æˆ -->
    <div id="memoryGame" class="hidden">
      <div class="module-header">
        <h1 class="module-title" style="color: var(--primary-blue);">ğŸƒ è®°å¿†ç¿»ç‰Œ</h1>
        <div class="game-score">å¾—åˆ†: <span class="score-display" id="memoryScore">0</span></div>
      </div>
      <div class="memory-game">
        <div class="memory-grid" id="memoryGrid"></div>
      </div>
      <button class="back-btn" onclick="backToMenu()" style="display: block; margin: 30px auto;">è¿”å›æ¸¸æˆèœå•</button>
    </div>

    <!-- å¬éŸ³é€‰å›¾æ¸¸æˆ -->
    <div id="listeningGame" class="hidden">
      <div class="module-header">
        <h1 class="module-title" style="color: var(--primary-green);">ğŸ‘‚ å¬éŸ³é€‰å›¾</h1>
        <div class="game-score">å¾—åˆ†: <span class="score-display" id="listeningScore">0</span></div>
      </div>
      <div class="listening-game">
        <button class="play-sound-btn" onclick="playQuestion()">ğŸ”Š</button>
        <p style="font-size: 20px; color: #78909C;">ç‚¹å‡»å¤§æŒ‰é’®å¬å‘éŸ³ï¼Œç„¶åé€‰æ‹©æ­£ç¡®çš„å›¾ç‰‡ï¼</p>
        <div class="options-grid" id="listeningOptions"></div>
      </div>
      <button class="back-btn" onclick="backToMenu()" style="display: block; margin: 30px auto;">è¿”å›æ¸¸æˆèœå•</button>
    </div>

    <!-- æ‹¼å›¾æ¸¸æˆ -->
    <div id="puzzleGame" class="hidden">
      <div class="module-header">
        <h1 class="module-title" style="color: var(--primary-yellow);">ğŸ§© å•è¯æ‹¼å›¾</h1>
        <div class="game-score">å¾—åˆ†: <span class="score-display" id="puzzleScore">0</span></div>
      </div>
      <div class="puzzle-game">
        <div class="puzzle-target" id="puzzleTarget"></div>
        <div class="puzzle-slots" id="puzzleSlots"></div>
        <div class="puzzle-letters" id="puzzleLetters"></div>
      </div>
      <button class="back-btn" onclick="backToMenu()" style="display: block; margin: 30px auto;">è¿”å›æ¸¸æˆèœå•</button>
    </div>
  </div>

  <script src="../data/content.js"></script>
  <script src="../js/main.js"></script>
  <script>
    // æ¸¸æˆçŠ¶æ€
    let currentGame = null;
    let memoryScore = 0;
    let listeningScore = 0;
    let puzzleScore = 0;
    
    // è®°å¿†æ¸¸æˆçŠ¶æ€
    let memoryCards = [];
    let flippedCards = [];
    let matchedPairs = 0;
    
    // å¬éŸ³æ¸¸æˆçŠ¶æ€
    let currentQuestion = null;
    let listeningQuestions = [];
    let currentQuestionIndex = 0;
    
    // æ‹¼å›¾æ¸¸æˆçŠ¶æ€
    let currentPuzzle = null;
    let puzzleSlots = [];
    let puzzleLetters = [];

    // å¼€å§‹æ¸¸æˆ
    function startGame(game) {
      SoundManager.playClick();
      currentGame = game;
      
      document.getElementById('gamesMenu').classList.add('hidden');
      document.getElementById('memoryGame').classList.add('hidden');
      document.getElementById('listeningGame').classList.add('hidden');
      document.getElementById('puzzleGame').classList.add('hidden');
      
      if (game === 'memory') {
        document.getElementById('memoryGame').classList.remove('hidden');
        initMemoryGame();
      } else if (game === 'listening') {
        document.getElementById('listeningGame').classList.remove('hidden');
        initListeningGame();
      } else if (game === 'puzzle') {
        document.getElementById('puzzleGame').classList.remove('hidden');
        initPuzzleGame();
      }
    }

    // è¿”å›èœå•
    function backToMenu() {
      SoundManager.playClick();
      currentGame = null;
      document.getElementById('gamesMenu').classList.remove('hidden');
      document.getElementById('memoryGame').classList.add('hidden');
      document.getElementById('listeningGame').classList.add('hidden');
      document.getElementById('puzzleGame').classList.add('hidden');
    }

    // ========== è®°å¿†ç¿»ç‰Œæ¸¸æˆ ==========
    function initMemoryGame() {
      memoryScore = 0;
      matchedPairs = 0;
      flippedCards = [];
      document.getElementById('memoryScore').textContent = '0';
      
      // é€‰æ‹©8ä¸ªå•è¯
      const allWords = Object.values(wordsData).flat().slice(0, 8);
      const cards = [];
      
      allWords.forEach((word, index) => {
        cards.push({ type: 'word', content: word.word, id: index });
        cards.push({ type: 'icon', content: word.icon, id: index });
      });
      
      // æ‰“ä¹±é¡ºåº
      memoryCards = cards.sort(() => Math.random() - 0.5);
      
      renderMemoryGrid();
    }

    function renderMemoryGrid() {
      const grid = document.getElementById('memoryGrid');
      grid.innerHTML = '';
      
      memoryCards.forEach((card, index) => {
        const cardEl = document.createElement('div');
        cardEl.className = 'memory-card';
        cardEl.dataset.index = index;
        cardEl.dataset.id = card.id;
        cardEl.onclick = () => flipCard(index);
        grid.appendChild(cardEl);
      });
    }

    function flipCard(index) {
      const cardEl = document.querySelector(`.memory-card[data-index="${index}"]`);
      
      // ä¸èƒ½ç¿»å·²ç»ç¿»å¼€çš„æˆ–å·²åŒ¹é…çš„
      if (cardEl.classList.contains('flipped') || cardEl.classList.contains('matched')) return;
      // ä¸èƒ½åŒæ—¶ç¿»è¶…è¿‡2å¼ 
      if (flippedCards.length >= 2) return;
      
      SoundManager.playClick();
      
      const card = memoryCards[index];
      cardEl.classList.add('flipped');
      cardEl.textContent = card.content;
      flippedCards.push({ index, id: card.id, element: cardEl });
      
      if (flippedCards.length === 2) {
        checkMatch();
      }
    }

    function checkMatch() {
      const [card1, card2] = flippedCards;
      
      if (card1.id === card2.id) {
        // åŒ¹é…æˆåŠŸ
        setTimeout(() => {
          card1.element.classList.add('matched');
          card2.element.classList.add('matched');
          SoundManager.playCorrect();
          
          memoryScore += 10;
          document.getElementById('memoryScore').textContent = memoryScore;
          matchedPairs++;
          
          flippedCards = [];
          
          // æ¸¸æˆå®Œæˆ
          if (matchedPairs === 8) {
            setTimeout(() => {
              ProgressManager.addStars(2);
              ProgressManager.setHighScore('memory', memoryScore);
              ModalManager.show('æ¸¸æˆå®Œæˆï¼', `æ­å–œä½ ï¼å¾—åˆ†: ${memoryScore}`, 'ğŸ‰', () => {
                backToMenu();
              });
            }, 500);
          }
        }, 500);
      } else {
        // åŒ¹é…å¤±è´¥
        setTimeout(() => {
          SoundManager.playWrong();
          card1.element.classList.remove('flipped');
          card2.element.classList.remove('flipped');
          card1.element.textContent = '';
          card2.element.textContent = '';
          flippedCards = [];
        }, 1000);
      }
    }

    // ========== å¬éŸ³é€‰å›¾æ¸¸æˆ ==========
    function initListeningGame() {
      listeningScore = 0;
      currentQuestionIndex = 0;
      document.getElementById('listeningScore').textContent = '0';
      
      // ç”Ÿæˆ10é“é¢˜
      const allWords = Object.values(wordsData).flat();
      listeningQuestions = [];
      
      for (let i = 0; i < 10; i++) {
        const correct = allWords[Math.floor(Math.random() * allWords.length)];
        const options = [correct];
        
        while (options.length < 3) {
          const random = allWords[Math.floor(Math.random() * allWords.length)];
          if (!options.find(o => o.word === random.word)) {
            options.push(random);
          }
        }
        
        listeningQuestions.push({
          correct: correct,
          options: options.sort(() => Math.random() - 0.5)
        });
      }
      
      showListeningQuestion();
    }

    function showListeningQuestion() {
      if (currentQuestionIndex >= listeningQuestions.length) {
        ProgressManager.addStars(2);
        ProgressManager.setHighScore('listening', listeningScore);
        ModalManager.show('æ¸¸æˆå®Œæˆï¼', `æ­å–œä½ ï¼å¾—åˆ†: ${listeningScore}`, 'ğŸ‰', () => {
          backToMenu();
        });
        return;
      }
      
      currentQuestion = listeningQuestions[currentQuestionIndex];
      
      const optionsGrid = document.getElementById('listeningOptions');
      optionsGrid.innerHTML = '';
      
      currentQuestion.options.forEach((option, index) => {
        const card = document.createElement('div');
        card.className = 'option-card';
        card.innerHTML = `<div class="option-image">${option.icon}</div>`;
        card.onclick = () => selectOption(option, card);
        optionsGrid.appendChild(card);
      });
      
      // è‡ªåŠ¨æ’­æ”¾
      setTimeout(() => playQuestion(), 500);
    }

    function playQuestion() {
      if (currentQuestion) {
        SpeechManager.speak(currentQuestion.correct.word);
      }
    }

    function selectOption(option, card) {
      if (option.word === currentQuestion.correct.word) {
        // æ­£ç¡®
        card.classList.add('correct');
        SoundManager.playCorrect();
        listeningScore += 10;
        document.getElementById('listeningScore').textContent = listeningScore;
        
        setTimeout(() => {
          currentQuestionIndex++;
          showListeningQuestion();
        }, 1000);
      } else {
        // é”™è¯¯
        card.classList.add('wrong');
        SoundManager.playWrong();
        card.classList.add('shake');
        
        setTimeout(() => {
          card.classList.remove('wrong', 'shake');
        }, 500);
      }
    }

    // ========== å•è¯æ‹¼å›¾æ¸¸æˆ ==========
    function initPuzzleGame() {
      puzzleScore = 0;
      document.getElementById('puzzleScore').textContent = '0';
      nextPuzzle();
    }

    function nextPuzzle() {
      const allWords = Object.values(wordsData).flat().filter(w => w.word.length <= 6);
      currentPuzzle = allWords[Math.floor(Math.random() * allWords.length)];
      
      document.getElementById('puzzleTarget').textContent = currentPuzzle.icon;
      
      // åˆ›å»ºæ’æ§½
      const slotsContainer = document.getElementById('puzzleSlots');
      slotsContainer.innerHTML = '';
      puzzleSlots = [];
      
      for (let i = 0; i < currentPuzzle.word.length; i++) {
        const slot = document.createElement('div');
        slot.className = 'puzzle-slot';
        slot.dataset.index = i;
        slotsContainer.appendChild(slot);
        puzzleSlots.push({ letter: currentPuzzle.word[i].toUpperCase(), filled: false, element: slot });
      }
      
      // åˆ›å»ºå­—æ¯é€‰é¡¹ï¼ˆåŒ…å«æ­£ç¡®ç­”æ¡ˆå’Œä¸€äº›å¹²æ‰°é¡¹ï¼‰
      const letters = currentPuzzle.word.toUpperCase().split('');
      const extraLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').filter(l => !letters.includes(l));
      
      // æ·»åŠ 2ä¸ªå¹²æ‰°å­—æ¯
      for (let i = 0; i < 2; i++) {
        letters.push(extraLetters[Math.floor(Math.random() * extraLetters.length)]);
      }
      
      const lettersContainer = document.getElementById('puzzleLetters');
      lettersContainer.innerHTML = '';
      
      letters.sort(() => Math.random() - 0.5).forEach(letter => {
        const letterEl = document.createElement('div');
        letterEl.className = 'puzzle-letter';
        letterEl.textContent = letter;
        letterEl.onclick = () => selectLetter(letter, letterEl);
        lettersContainer.appendChild(letterEl);
      });
      
      // æ’­æ”¾å•è¯
      setTimeout(() => {
        SpeechManager.speak(currentPuzzle.word);
      }, 500);
    }

    function selectLetter(letter, element) {
      SoundManager.playClick();
      
      // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºæ’æ§½
      const emptySlot = puzzleSlots.find(slot => !slot.filled);
      
      if (emptySlot) {
        if (letter === emptySlot.letter) {
          // æ­£ç¡®
          emptySlot.filled = true;
          emptySlot.element.textContent = letter;
          emptySlot.element.classList.add('filled');
          element.style.visibility = 'hidden';
          SoundManager.playCorrect();
          
          // æ£€æŸ¥æ˜¯å¦å®Œæˆ
          if (puzzleSlots.every(slot => slot.filled)) {
            puzzleScore += 10;
            document.getElementById('puzzleScore').textContent = puzzleScore;
            
            setTimeout(() => {
              SpeechManager.speak(currentPuzzle.word);
              
              if (puzzleScore >= 50) {
                ProgressManager.addStars(2);
                ProgressManager.setHighScore('puzzle', puzzleScore);
                ModalManager.show('æ¸¸æˆå®Œæˆï¼', `æ­å–œä½ ï¼å¾—åˆ†: ${puzzleScore}`, 'ğŸ‰', () => {
                  backToMenu();
                });
              } else {
                nextPuzzle();
              }
            }, 1000);
          }
        } else {
          // é”™è¯¯
          element.classList.add('shake');
          SoundManager.playWrong();
          
          setTimeout(() => {
            element.classList.remove('shake');
          }, 500);
        }
      }
    }

    // è¿”å›å¤§å…
    function goBack() {
      SoundManager.playClick();
      window.location.href = '../hall.html';
    }
  </script>
</body>
</html>
