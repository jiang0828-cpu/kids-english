<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>éŸ³ä¹å‰§åœº - KidsEnglish</title>
  <link rel="stylesheet" href="../css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header class="header">
      <div class="logo">
        <span class="logo-icon">ğŸ¼</span>
        <span>KidsEnglish</span>
      </div>
      <div style="display: flex; gap: 15px; align-items: center;">
        <div class="progress-bar">
          <span>â­</span>
          <span class="star-count">0</span>
        </div>
        <button class="back-btn" onclick="goBack()">â† è¿”å›</button>
      </div>
    </header>

    <!-- æ¨¡å—æ ‡é¢˜ -->
    <div class="module-header">
      <h1 class="module-title" style="color: var(--primary-purple);">ğŸµ éŸ³ä¹å‰§åœº</h1>
      <p>ç‚¹å‡»å„¿æ­Œï¼Œä¸€èµ·å”±èµ·æ¥ï¼</p>
    </div>

    <!-- å„¿æ­Œåˆ—è¡¨ -->
    <div class="songs-list" id="songsList">
      <!-- å„¿æ­Œåˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>

  <!-- æ­Œè¯å¼¹çª— -->
  <div class="modal-overlay" id="lyricsModal" onclick="closeLyrics(event)">
    <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
      <div class="modal-icon">ğŸµ</div>
      <div class="modal-title" id="lyricsTitle"></div>
      <div id="lyricsContent" style="font-size: 20px; line-height: 2; margin: 30px 0; text-align: left; padding: 0 20px;"></div>
      <button class="modal-btn" onclick="singSong()">ğŸ¤ è·Ÿæˆ‘å”±</button>
      <button class="modal-btn" style="background: #78909C; margin-left: 10px;" onclick="closeLyricsModal()">å…³é—­</button>
    </div>
  </div>

  <script src="../data/content.js"></script>
  <script src="../js/main.js"></script>
  <script>
    let currentSongIndex = -1;
    let sungSongs = new Set();

    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', () => {
      loadProgress();
      renderSongs();
    });

    // æ¸²æŸ“å„¿æ­Œåˆ—è¡¨
    function renderSongs() {
      const list = document.getElementById('songsList');
      list.innerHTML = '';
      
      songsData.forEach((song, index) => {
        const item = document.createElement('div');
        item.className = 'song-item fade-in';
        item.style.animationDelay = `${index * 0.1}s`;
        
        if (sungSongs.has(index)) {
          item.style.borderLeft = '5px solid var(--primary-green)';
        }
        
        item.innerHTML = `
          <div class="song-number">${index + 1}</div>
          <div class="song-info">
            <div class="song-title">${song.title}</div>
            <div class="song-duration">${song.titleChinese} Â· ${song.duration}</div>
          </div>
          <button class="song-play-btn" onclick="showLyrics(${index}, event)">â–¶ï¸</button>
        `;
        
        list.appendChild(item);
      });
    }

    // æ˜¾ç¤ºæ­Œè¯
    function showLyrics(index, event) {
      event.stopPropagation();
      SoundManager.playClick();
      
      currentSongIndex = index;
      const song = songsData[index];
      
      document.getElementById('lyricsTitle').textContent = song.title;
      
      const lyricsHtml = song.lyrics.map((line, i) => 
        `<div style="padding: 8px 0; ${i % 2 === 0 ? 'color: var(--primary-purple); font-weight: 700;' : 'color: #78909C;'}">${line}</div>`
      ).join('');
      
      document.getElementById('lyricsContent').innerHTML = lyricsHtml;
      document.getElementById('lyricsModal').classList.add('active');
      
      // æ ‡è®°ä¸ºå·²å”±
      if (!sungSongs.has(index)) {
        sungSongs.add(index);
        
        // æ¯å”±ä¸€é¦–æ­Œå¥–åŠ±ä¸€é¢—æ˜Ÿ
        ProgressManager.addStars(1);
        saveProgress();
        
        // æ›´æ–°åˆ—è¡¨æ ·å¼
        renderSongs();
      }
    }

    // å”±å„¿æ­Œï¼ˆé€å¥æœ—è¯»ï¼‰
    function singSong() {
      if (currentSongIndex < 0) return;
      
      const song = songsData[currentSongIndex];
      let delay = 0;
      
      song.lyrics.forEach((line, index) => {
        setTimeout(() => {
          // é«˜äº®å½“å‰è¡Œ
          const lines = document.getElementById('lyricsContent').children;
          Array.from(lines).forEach((l, i) => {
            l.style.background = i === index ? '#F3E5F5' : 'transparent';
            l.style.borderRadius = '8px';
            l.style.padding = '8px 15px';
          });
          
          // æœ—è¯»
          SpeechManager.speak(line, 0.7, 1.3);
        }, delay);
        
        delay += 2500; // æ¯å¥é—´éš”2.5ç§’
      });
      
      // æ’­æ”¾å®Œåå–æ¶ˆé«˜äº®
      setTimeout(() => {
        const lines = document.getElementById('lyricsContent').children;
        Array.from(lines).forEach(l => {
          l.style.background = 'transparent';
        });
      }, delay);
    }

    // å…³é—­æ­Œè¯å¼¹çª—
    function closeLyricsModal() {
      document.getElementById('lyricsModal').classList.remove('active');
      SpeechManager.stop();
      currentSongIndex = -1;
    }

    // ç‚¹å‡»é®ç½©å…³é—­
    function closeLyrics(event) {
      if (event.target === document.getElementById('lyricsModal')) {
        closeLyricsModal();
      }
    }

    // ä¿å­˜è¿›åº¦
    function saveProgress() {
      const progress = Math.round((sungSongs.size / songsData.length) * 100);
      ProgressManager.setProgress('songs', progress);
      localStorage.setItem('kidsEnglish_sungSongs', JSON.stringify([...sungSongs]));
    }

    // åŠ è½½è¿›åº¦
    function loadProgress() {
      const saved = localStorage.getItem('kidsEnglish_sungSongs');
      if (saved) {
        sungSongs = new Set(JSON.parse(saved));
      }
    }

    // è¿”å›å¤§å…
    function goBack() {
      SoundManager.playClick();
      SpeechManager.stop();
      window.location.href = '../hall.html';
    }
  </script>
</body>
</html>
